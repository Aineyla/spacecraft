var T3D,Game;!function(t){t.RAD_SCALE=Math.PI/180;class e{constructor(t,e,s){this.x=0,this.y=0,this.z=0,this.set(t,e,s)}set(t,s,i){return t instanceof e?(this.x=t.x,this.y=t.y,this.z=t.z,this):("number"==typeof t&&(this.x=t),"number"==typeof s&&(this.y=s),"number"==typeof i&&(this.z=i),this)}max(){return Math.max(this.x,this.y,this.z)}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}distance(t){return Math.sqrt((this.x-t.x)*(this.x-t.x)+(this.y-t.y)*(this.y-t.y)+(this.z-t.z)*(this.z-t.z))}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}cross(t){let e=this.x,s=this.y,i=this.z,r=t.x,a=t.y,n=t.z;return this.x=s*n-i*a,this.y=i*r-e*n,this.z=e*a-s*r,this}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}scale(t){return this.x*=t instanceof e?t.x:t,this.y*=t instanceof e?t.y:t,this.z*=t instanceof e?t.z:t,this}normalize(){var t=this.length();return t>0&&this.scale(1/t),this}clone(){return new e(this.x,this.y,this.z)}invert(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}toArray(){return[this.x,this.y,this.z]}}t.Vec3=e;class s{constructor(t){this.data=t||[0,0,0,0,0,0,0,0,0]}transpose(){const t=this.data,e=t[1],s=t[2],i=t[5];return t[1]=t[3],t[2]=t[6],t[3]=e,t[5]=t[7],t[6]=s,t[7]=i,this}}t.Mat3=s;class i{constructor(t){this.data=t||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}clone(){return new i(this.data)}multiply(t){const e=this.data,s=e[0],i=e[1],r=e[2],a=e[3],n=e[4],h=e[5],o=e[6],c=e[7],l=e[8],u=e[9],m=e[10],d=e[11],f=e[12],p=e[13],g=e[14],x=e[15],v=t[0],y=t[1],w=t[2],z=t[3],T=t[4],b=t[5],k=t[6],M=t[7],S=t[8],D=t[9],A=t[10],E=t[11],R=t[12],N=t[13],F=t[14],C=t[15];return this.data=[s*v+i*T+r*S+a*R,s*y+i*b+r*D+a*N,s*w+i*k+r*A+a*F,s*z+i*M+r*E+a*C,n*v+h*T+o*S+c*R,n*y+h*b+o*D+c*N,n*w+h*k+o*A+c*F,n*z+h*M+o*E+c*C,l*v+u*T+m*S+d*R,l*y+u*b+m*D+d*N,l*w+u*k+m*A+d*F,l*z+u*M+m*E+d*C,f*v+p*T+g*S+x*R,f*y+p*b+g*D+x*N,f*w+p*k+g*A+x*F,f*z+p*M+g*E+x*C],this}scale(t){return this.multiply([t.x,0,0,0,0,t.y,0,0,0,0,t.z,0,0,0,0,1])}translate(t){return this.multiply([1,0,0,0,0,1,0,0,0,0,1,0,t.x,t.y,t.z,1])}rotateX(t){const e=Math.cos(t),s=Math.sin(t);return this.multiply([1,0,0,0,0,e,s,0,0,-s,e,0,0,0,0,1])}rotateY(t){const e=Math.cos(t),s=Math.sin(t);return this.multiply([e,0,-s,0,0,1,0,0,s,0,e,0,0,0,0,1])}rotateZ(t){const e=Math.cos(t),s=Math.sin(t);return this.multiply([e,s,0,0,-s,e,0,0,0,0,1,0,0,0,0,1])}rotate(t){return this.rotateX(t.x).rotateY(t.y).rotateZ(t.z)}perspective(t,e,s,i){const r=Math.tan(.5*Math.PI-.5*t),a=1/(s-i);return this.multiply([r/e,0,0,0,0,r,0,0,0,0,(s+i)*a,-1,0,0,s*i*a*2,0])}invert(){const t=this.data,e=t[0],i=t[1],r=t[2],a=t[4],n=t[5],h=t[6],o=t[8],c=t[9],l=t[10],u=l*n-h*c,m=-l*a+h*o,d=c*a-n*o,f=e*u+i*m+r*d;if(!f)return null;const p=1/f;return new s([u*p,(-l*i+r*c)*p,(h*i-r*n)*p,m*p,(l*e-r*o)*p,(-h*e+r*a)*p,d*p,(-c*e+i*o)*p,(n*e-i*a)*p])}}t.Mat4=i;class r{constructor(t,e){this.transform=t,this.scale=e||t.scale}getTranslate(){let t=this.transform.translate.clone(),e=this.transform.parent;for(;e;)t.scale(e.scale).add(e.translate),e=e.parent;return t}getScale(){let t=this.scale.clone().scale(.5),e=this.transform.parent;for(;e;)t.scale(e.scale),e=e.parent;return t}}t.Collider=r;t.Sphere=class extends r{intersect(t){let e=null,s=this.getTranslate(),i=t.getTranslate(),r=s.distance(i),a=this.getScale().max()+t.getScale().max();return r<a&&(e=i.sub(s).normalize().scale(a-r)),e}};t.Box=class extends r{intersect(t){let s=this.getTranslate(),i=this.getScale(),r=t.getTranslate(),a=t.getScale().max(),n=new e(Math.max(s.x-i.x,Math.min(r.x,s.x+i.x)),Math.max(s.y-i.y,Math.min(r.y,s.y+i.y)),Math.max(s.z-i.z,Math.min(r.z,s.z+i.z))),h=n.distance(r),o=null;return h<a&&(o=r.sub(n).normalize().scale(a-h)),o}};class a{constructor(t=[]){this.translate=new e(t[0]||0,t[1]||0,t[2]||0),this.rotate=new e(t[3]||0,t[4]||0,t[5]||0),this.scale=new e(t[6]||1,t[7]||1,t[8]||1)}matrix(e){return(e=e||new i).scale(this.scale).rotate(this.rotate.clone().scale(t.RAD_SCALE)).translate(this.translate),this.parent?this.parent.matrix(e):e}}t.Transform=a;t.Camera=class{constructor(t=1,s=45,i=.1,r=100){this.rotate=new e,this.position=new e,this.fov=s,this.aspect=t,this.near=i,this.far=r}transform(t){return t.matrix().rotate(this.rotate.clone().invert()).translate(this.position.clone().invert())}perspective(){return(new i).perspective(this.fov,this.aspect,this.near,this.far)}};class n extends e{constructor(){super(...arguments),this.faces=[]}addFace(t){return this.faces.push(t),this}}class h{constructor(t,e,s){this.verts=[],this.normals=[],t.addFace(this),e.addFace(this),s.addFace(this),this.verts.push(t,e,s),this.normal=e.clone().sub(t).cross(s.clone().sub(t)).normalize()}calcNormals(t){return this.verts.forEach((e,s)=>{let i;e.faces.forEach(e=>{this.normal.dot(e.normal)>t&&(i=i?i.add(e.normal):e.normal.clone())}),this.normals.push(i?i.normalize():this.normal)}),this}pushVerts(t){return this.verts.forEach(e=>{t.push(...e.toArray())}),this}pushNormals(t){return this.normals.forEach(e=>{t.push(...e.toArray())}),this}}t.Mesh=class{constructor(e,s,i=[],r=0,a=360){if(s<2)return;i.length<2&&(i=this.sphere(i.length>0?i[0]+2:Math.ceil(s/2)+1));const n=this.createVerts(s,i,0,a),h=this.createFaces(n,s,i.length/2),o=Math.cos(r*t.RAD_SCALE),c=[],l=[];h.forEach(t=>{t.calcNormals(o).pushVerts(c).pushNormals(l)}),this.verts=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.verts),e.bufferData(e.ARRAY_BUFFER,new Float32Array(c),e.STATIC_DRAW),this.normals=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.normals),e.bufferData(e.ARRAY_BUFFER,new Float32Array(l),e.STATIC_DRAW),this.length=c.length/3}sphere(t){const e=[];if(t<3)return;let s=Math.PI/(t-1);for(let i=1;i<t-1;i++){let t=s*i;e.push(Math.sin(t)/2),e.push(Math.cos(t)/2)}return e}createVerts(e,s,i,r){i*=t.RAD_SCALE;let a=[],h=((r*=t.RAD_SCALE)-i)/e;a.push(new n(0,.5,0)),a.push(new n(0,-.5,0));for(let t=0;t<e;t++){let e=h*t+i,r=Math.cos(e),o=Math.sin(e);for(let t=0;t<s.length;t+=2){let e=new n(r,0,o);e.scale(s[t]).y=s[t+1],a.push(e)}}return a}createFaces(t,e,s){const i=[];let r;for(let a=1;a<e;++a){r=a*s+2,i.push(new h(t[0],t[r],t[r-s])),i.push(new h(t[1],t[r-1],t[r+s-1]));for(let e=0;e<s-1;e++){let a=r+e;i.push(new h(t[a+1],t[a-s],t[a])),i.push(new h(t[a-s+1],t[a-s],t[a+1]))}}i.push(new h(t[0],t[2],t[r])),i.push(new h(t[1],t[r+s-1],t[s+1]));for(let e=0;e<s-1;e++){let s=r+e;i.push(new h(t[e+3],t[s],t[e+2])),i.push(new h(t[s+1],t[s],t[e+3]))}return i}};t.Item=class{constructor(t,e,s){this.childs=[],this.active=!0,this.stroke=0,this.mesh=t,this.color=e,this.transform=new a(s)}add(t){return this.childs.push(t),t.transform.parent=this.transform,this}};t.Shader=class{constructor(t,e,s){this.attribs={},this.location={},this.gl=t,this.program=t.createProgram(),this.indices=t.createBuffer();const i=this.program;t.attachShader(i,this.create(t.VERTEX_SHADER,e)),t.attachShader(i,this.create(t.FRAGMENT_SHADER,s)),t.linkProgram(i),t.getProgramParameter(i,t.LINK_STATUS)||(console.log(t.getProgramInfoLog(i)),t.deleteProgram(i))}create(t,e){const s=this.gl,i=s.createShader(t);return s.shaderSource(i,e),s.compileShader(i),s.getShaderParameter(i,s.COMPILE_STATUS)||console.log(s.getShaderInfoLog(i)),i}attrib(t,e,s){const i=this.gl;this.location[t]||(this.location[t]=i.getAttribLocation(this.program,t));const r=this.location[t];return i.bindBuffer(i.ARRAY_BUFFER,e),i.enableVertexAttribArray(r),i.vertexAttribPointer(r,s,i.FLOAT,!1,0,0),this}uniform(t,e){const s=this.gl;this.location[t]||(this.location[t]=s.getUniformLocation(this.program,t));const i=this.location[t];if("number"==typeof e)return s.uniform1f(i,e),this;switch(e.length){case 2:s.uniform2fv(i,e);break;case 3:s.uniform3fv(i,e);break;case 4:s.uniform4fv(i,e);break;case 9:s.uniformMatrix3fv(i,!1,e);break;case 16:s.uniformMatrix4fv(i,!1,e)}return this}}}(T3D||(T3D={})),function(t){t.Enemy=class extends T3D.Item{update(t,e){let s=this.transform.translate,i=this.transform.rotate;i.z=(i.z+5)%360,s.z=e?0:s.z+t/2}intersect(t){this.active&&this.collider.intersect(t.collider)&&(t.explode=7)}}}(Game||(Game={})),function(t){t.Hero=class extends T3D.Item{init(){const t=this.transform;t.translate.set(0,3,2),t.rotate.set(0,0,0),this.active=!0,this.transform=t,this.collider=new T3D.Sphere(t),this.x=0,this.rad=.4,this.acc=-.02,this.speed=new T3D.Vec3(0,0,.1),this.speedTime=0,this.scale=.8,this.scaleTime=0,this.tokens=0,this.distance=0,this.explode=0,this.stroke=0}left(){this.x>=0&&this.x--}right(){this.x<=0&&this.x++}jump(){this.collide&&(this.acc=.065)}boost(){this.speedTime=75}dash(){this.scaleTime=40}cancel(){this.x=Math.round(this.transform.translate.x)}update(){let t=this.transform.translate,e=this.scale,s=this.transform.rotate,i=(this.speedTime?.12:.06)+Math.min(this.distance/1e4,.05);this.speed.z+=((this.active?i:0)-this.speed.z)/20,this.speedTime-=this.speedTime>0?1:0,this.scale+=((this.scaleTime?.5:.8)-this.scale)/5,this.scaleTime-=this.scaleTime>0?1:0,this.stroke+=(this.explode-this.stroke)/25,this.active=t.y>-10&&this.stroke<6,this.active&&!this.stroke&&(this.acc-=this.acc>-.02?.01:0,s.z=90+25*(t.x-this.x),s.y=(s.y+100*this.speed.z)%360,this.speed.y+=this.acc,t.x+=(this.x-t.x)/7,t.y+=this.speed.y,t.z-=t.z/30,this.transform.scale.set(e,e,e))}}}(Game||(Game={})),function(t){t.Map=class{constructor(t,e=4,s=50){this.config=t.split("|"),this.length=e,this.steps=s}init(){this.count=0,this.data=[],this.step=0,this.min=0,this.update()}max(){let t=this.min+this.length,e=this.config.length;return t<e?t:e-1}update(){if(++this.step>this.steps&&(this.step=0,this.min+this.length<this.config.length-1&&this.min++),!(--this.count>0)){if(!this.data.length){this.mirror=t.Rand.get()>.5;let e=t.Rand.get(this.max(),this.min,!0);this.data=this.config[e].match(/.{1,4}/g)}this.row=this.data.shift().split("").map(t=>parseInt(t,36)),this.count=this.row.shift(),this.mirror&&this.row.reverse()}}}}(Game||(Game={})),function(t){const e="offliner_hi";t.Menu=class{constructor(){this.body=t.$("body"),this.left=t.$("#left"),this.right=t.$("#right"),this.scores=document.getElementsByTagName("H3"),this.planets=document.getElementsByTagName("LI"),this.index=this.planets.length-1,this.left.className="disabled",this.storage=JSON.parse(localStorage.getItem(e))||[],this.active=!0;for(let t=0;t<this.planets.length;t++)this.storage[t]&&(this.scores.item(2*t).textContent="High Score: "+this.storage[t]);this.bind()}score(t){let s=2*this.index,i=this.storage[this.index]||0,r=i<t;r&&(this.storage[this.index]=t,localStorage.setItem(e,JSON.stringify(this.storage))),this.scores.item(s).textContent=r?"New High Score!":"High Score: "+i,this.scores.item(s+1).textContent=(r?"":"Score: ")+t}input(t){if(this.active)switch(t){case 37:this.prev();break;case 39:this.next()}}prev(){this.left.className||(this.planets.item(++this.index).className="",this.index>=this.planets.length-1&&(this.left.className="disabled"),this.right.className="")}next(){this.right.className||(this.planets.item(this.index--).className="hide",this.index<=0&&(this.right.className="disabled"),this.left.className="")}show(){this.active=!0,this.body.className=""}hide(){this.active=!1,this.body.className="play"}bind(){t.on(this.left,"click",t=>{this.prev()}),t.on(this.right,"click",t=>{this.next()})}}}(Game||(Game={})),function(t){t.Platform=class extends T3D.Item{update(t){let e=this.transform.translate,s=this.token.transform.rotate;e.z+=t;let i=e.z>2;i&&(e.z-=11);let r=1;return e.z<-8?r=e.z+9:e.z>1&&(r=2-e.z),this.transform.scale.set(r,r,r),s.y=(s.y+1.5)%360,this.enemy.update(t,i),i}intersect(t,e=!1){let s,i=this.token,r=this.fence;if(i.active&&i.collider.intersect(t.collider)&&(i.active=!1,t.tokens++),r.active&&(s=r.collider.intersect(t.collider))&&(e&&s.x&&t.cancel(),t.transform.translate.add(s),t.speed.y+=s.y),this.block.active)return(s=this.block.collider.intersect(t.collider))&&(e&&s.x&&t.cancel(),t.transform.translate.add(s),t.speed.y+=s.y),s}}}(Game||(Game={})),function(t){t.Scene=class extends T3D.Item{constructor(e,s,i){super(),this.map=new t.Map(i),this.hud=t.$("#hud").getElementsByTagName("DIV"),this.hero=e,this.add(this.hero),this.platforms=[];for(let t=0;t<33;t++){let t=s();this.platforms.push(t),this.add(t)}this.init()}init(){this.row=9,this.hero.init(),this.map.init();let t=0;for(let e=-9;e<2;e++)for(let s=-1;s<=1;s++){let i=this.platforms[t++];i.transform.translate.set(s,-1,e),i.enemy.active=i.fence.active=i.token.active=!1,i.block.active=!0}}ended(){return Math.abs(this.hero.speed.z)<.01}score(){return Math.round(10*this.hero.tokens+this.hero.distance)}input(t){const e=this.hero;switch(t){case 37:e.left();break;case 39:e.right();break;case 38:e.jump();break;case 40:e.dash();break;case 32:e.boost()}}updateRow(t){this.row-=t,this.row<=-.5&&(this.row+=11),this.index=3*Math.round(this.row)+Math.round(this.hero.transform.translate.x)+1}getIndex(t=0){let e=this.platforms.length,s=this.index+t;return s<0?s+e:s>=e?s-e:s}update(){this.hero.update();let t=!1,e=this.hero,s=e.speed.z;this.platforms.forEach((i,r)=>{if(i.update(s)){let e=this.map.row[r%3],s=e>>2;i.block.active=(1&e)>0,i.transform.translate.y=(2&e)>0?0:-1,i.token.active=1==s,i.fence.active=2==s,i.enemy.active=3==s,i.token.transform.rotate.y=45,t=!0}i.enemy.intersect(e)}),t&&this.map.update(),this.updateRow(s),e.collide=this.platforms[this.getIndex()].intersect(e),[-3,3,-1,1,-2,2,-4,4].forEach(t=>{let s=this.getIndex(t);this.platforms[s].intersect(e,1==t||-1==t)}),e.distance+=s,this.hud.item(2).textContent=""+this.score(),this.hud.item(3).textContent=e.distance.toFixed(0)}}}(Game||(Game={})),function(t){function e(t,e){return(e||document).querySelector(t)}function s(t,e,s){t.addEventListener(e,s,!1)}t.$=e,t.on=s,t.fullscreen=function(){document.webkitFullscreenElement?document.webkitExitFullscreen&&(document.webkitExitFullscreen(),document.exitPointerLock()):(document.documentElement.webkitRequestFullscreen(),r.requestPointerLock())};class i{static get(t=1,e=0,s=!0){if(t<=e)return t;i.seed=(9301*i.seed+49297)%233280;let r=e+i.seed/233280*(t-e);return s?Math.round(r):r}}i.seed=Math.random(),t.Rand=i;let r=e("#game"),a=new t.Menu,n=(new Date).getTime(),h=r.getContext("webgl"),o=new T3D.Vec3(5,15,7),c=new T3D.Camera(r.width/r.height),l=new T3D.Shader(h,"precision mediump float;attribute vec3 aPos, aNorm;uniform mat4 uWorld, uProj;uniform mat3 uInverse;uniform float uStroke;varying vec4 vPos;varying vec3 vNorm;void main(void) {vec3 pos = aPos + (aNorm * uStroke);vPos = uWorld * vec4(pos, 1.0);vNorm = uInverse * aNorm;gl_Position = uProj * vPos;}","precision mediump float;uniform mat4 uWorld;uniform vec4 uColor;uniform vec3 uLight;uniform float uLevels;varying vec4 vPos;varying vec3 vNorm;vec3 uAmbient = vec3(.2, .2, .2);vec3 uDiffuse = vec3(.8, .8, .8);vec3 uSpecular = vec3(.8, .8, .8);void main(void) {vec3 lightDir = normalize(uLight - vPos.xyz);vec3 normal = normalize(vNorm);vec3 eyeDir = normalize(-vPos.xyz);vec3 reflectionDir = reflect(-lightDir, normal);float specularWeight = 0.0;if (uColor.w > 0.0) { specularWeight = pow(max(dot(reflectionDir, eyeDir), 0.0), uColor.w); }float diffuseWeight = max(dot(normal, lightDir), 0.0);vec3 weight = uAmbient + uSpecular * specularWeight  + uDiffuse * diffuseWeight;vec3 color = uColor.xyz * weight;if (uLevels > 1.0) { color = floor(color * uLevels) * (1.0 / uLevels); }gl_FragColor = vec4(color, 1);}"),u={hero:new T3D.Mesh(h,10),block:new T3D.Mesh(h,4,[.55,.5,.65,.4,.65,-.4,.55,-.5]),fence:new T3D.Mesh(h,12,[.4,.5,.5,.4,.5,-.4,.4,-.5],30),token:new T3D.Mesh(h,9,[.45,.3,.45,.5,.5,.5,.5,-.5,.45,-.5,.45,-.3],30),enemy:new T3D.Mesh(h,4)},m=[.9,.9,.9,10],d=[1,.3,1,30],f=[.3,.3,1,30],p=[1,1,.3,30],g=[1,.3,.3,0],x=new t.Hero(u.hero,m),v=new t.Scene(x,()=>{let e=new t.Platform,s=new T3D.Item(u.block,f,[,,,,45]),i=new t.Enemy(u.enemy,d,[,1,,,,,.7,.7,.7]),r=new T3D.Item(u.token,p,[,1,,90,,,.5,.1,.5]),a=new T3D.Item(u.fence,g,[,1.5,,,,,.8,1,.8]);return s.collider=new T3D.Box(s.transform),i.collider=new T3D.Sphere(i.transform),r.collider=new T3D.Sphere(r.transform),a.collider=new T3D.Box(a.transform),e.block=s,e.token=r,e.fence=a,e.enemy=i,e.add(s).add(r).add(a).add(i)},"4111|211125052111|301521513510|205120052051|311113973111|611111d1");function y(){r.width=r.clientWidth,r.height=r.clientHeight,c.aspect=r.width/r.height,h.viewport(0,0,r.width,r.height)}function w(t,e=0){t.childs.forEach(t=>{w(t,e)});t.transform.scale;if(!t.active||!t.mesh)return;let s=t.transform.matrix().invert();s&&(h.cullFace(e>0?h.FRONT:h.BACK),h.useProgram(l.program),l.attrib("aPos",t.mesh.verts,3).attrib("aNorm",t.mesh.normals,3).uniform("uWorld",c.transform(t.transform).data).uniform("uProj",c.perspective().data).uniform("uInverse",s.transpose().data).uniform("uColor",e?[0,0,0,1]:t.color).uniform("uLight",o.clone().sub(c.position).toArray()).uniform("uStroke",e+t.stroke).uniform("uLevels",e?0:5),h.drawArrays(h.TRIANGLES,0,t.mesh.length))}function z(){if(requestAnimationFrame(z),h.clear(h.COLOR_BUFFER_BIT),a.active)return;let t=(new Date).getTime();t-n>30&&v.update(),n=t,v.update(),w(v),w(v,.02),v.ended()&&(a.score(v.score()),a.show())}s(window,"load",()=>{c.position.set(0,.5,5),c.rotate.x=-.8,h.clearColor(0,0,0,0),h.enable(h.CULL_FACE),h.enable(h.DEPTH_TEST),y(),function(){let t=0,i=0,r=[],n=!1;s(document,"touchstart",e=>{let s=e.touches[0];t=s.clientX,i=s.clientY,n=!0}),s(document,"touchmove",e=>{if(!n)return;let s=e.touches[0];!r[39]&&s.clientX-t>20?(r[39]=!0,v.input(39),n=!1):!r[37]&&s.clientX-t<-20?(r[37]=!0,v.input(37),n=!1):!r[40]&&s.clientY-i>20?(r[40]=!0,v.input(40),n=!1):!r[38]&&s.clientY-i<-20&&(r[38]=!0,v.input(38),n=!1)}),s(document,"touchend",t=>{n&&(r[32]=!0,v.input(32)),r[32]=r[37]=r[38]=r[39]=r[40]=n=!1}),s(document,"keydown",t=>{a.active?32==t.keyCode?(a.hide(),v.init()):a.input(t.keyCode):v.input(t.keyCode)}),s(e("#play"),"click",()=>{a.hide(),v.init()}),s(window,"resize",y)}(),z()})}(Game||(Game={}));