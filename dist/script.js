var T3D,Game;!function(t){t.RAD_SCALE=Math.PI/180;class e{constructor(t,e,r){this.x=0,this.y=0,this.z=0,this.set(t,e,r)}set(t,r,s){return t instanceof e?(this.x=t.x,this.y=t.y,this.z=t.z,this):("number"==typeof t&&(this.x=t),"number"==typeof r&&(this.y=r),"number"==typeof s&&(this.z=s),this)}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}cross(t){let e=this.x,r=this.y,s=this.z,i=t.x,o=t.y,a=t.z;return this.x=r*a-s*o,this.y=s*i-e*a,this.z=e*o-r*i,this}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}scale(t){return this.x*=t,this.y*=t,this.z*=t,this}normalize(){var t=this.length();return t>0&&this.scale(1/t),this}clone(){return new e(this.x,this.y,this.z)}invert(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}toArray(){return[this.x,this.y,this.z]}}t.Vec3=e;class r{constructor(t){this.data=t||[0,0,0,0,0,0,0,0,0]}transpose(){const t=this.data,e=t[1],r=t[2],s=t[5];return t[1]=t[3],t[2]=t[6],t[3]=e,t[5]=t[7],t[6]=r,t[7]=s,this}}t.Mat3=r;class s{constructor(t){this.data=t||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}clone(){return new s(this.data)}multiply(t){const e=this.data,r=e[0],s=e[1],i=e[2],o=e[3],a=e[4],n=e[5],h=e[6],c=e[7],u=e[8],l=e[9],m=e[10],f=e[11],d=e[12],p=e[13],v=e[14],w=e[15],y=t[0],g=t[1],x=t[2],A=t[3],z=t[4],D=t[5],b=t[6],R=t[7],S=t[8],T=t[9],E=t[10],M=t[11],F=t[12],L=t[13],P=t[14],k=t[15];return this.data=[r*y+s*z+i*S+o*F,r*g+s*D+i*T+o*L,r*x+s*b+i*E+o*P,r*A+s*R+i*M+o*k,a*y+n*z+h*S+c*F,a*g+n*D+h*T+c*L,a*x+n*b+h*E+c*P,a*A+n*R+h*M+c*k,u*y+l*z+m*S+f*F,u*g+l*D+m*T+f*L,u*x+l*b+m*E+f*P,u*A+l*R+m*M+f*k,d*y+p*z+v*S+w*F,d*g+p*D+v*T+w*L,d*x+p*b+v*E+w*P,d*A+p*R+v*M+w*k],this}scale(t){return this.multiply([t.x,0,0,0,0,t.y,0,0,0,0,t.z,0,0,0,0,1])}translate(t){return this.multiply([1,0,0,0,0,1,0,0,0,0,1,0,t.x,t.y,t.z,1])}rotateX(t){const e=Math.cos(t),r=Math.sin(t);return this.multiply([1,0,0,0,0,e,r,0,0,-r,e,0,0,0,0,1])}rotateY(t){const e=Math.cos(t),r=Math.sin(t);return this.multiply([e,0,-r,0,0,1,0,0,r,0,e,0,0,0,0,1])}rotateZ(t){const e=Math.cos(t),r=Math.sin(t);return this.multiply([e,r,0,0,-r,e,0,0,0,0,1,0,0,0,0,1])}rotate(t){return this.rotateX(t.x).rotateY(t.y).rotateZ(t.z)}perspective(t,e,r,s){const i=Math.tan(.5*Math.PI-.5*t),o=1/(r-s);return this.multiply([i/e,0,0,0,0,i,0,0,0,0,(r+s)*o,-1,0,0,r*s*o*2,0])}invert(){const t=this.data,e=t[0],s=t[1],i=t[2],o=t[4],a=t[5],n=t[6],h=t[8],c=t[9],u=t[10],l=u*a-n*c,m=-u*o+n*h,f=c*o-a*h,d=e*l+s*m+i*f;if(!d)return null;const p=1/d;return new r([l*p,(-u*s+i*c)*p,(n*s-i*a)*p,m*p,(u*e-i*h)*p,(-n*e+i*o)*p,f*p,(-c*e+s*h)*p,(a*e-s*o)*p])}}t.Mat4=s;class i{constructor(t=[]){this.translate=new e(t[0]||0,t[1]||0,t[2]||0),this.rotate=new e(t[3]||0,t[4]||0,t[5]||0),this.scale=new e(t[6]||1,t[7]||1,t[8]||1)}matrix(e){return(e=e||new s).scale(this.scale).rotate(this.rotate.clone().scale(t.RAD_SCALE)).translate(this.translate),this.parent?this.parent.matrix(e):e}}t.Transform=i;t.Camera=class{constructor(t=1,r=45,s=.1,i=100){this.rotate=new e,this.position=new e,this.fov=r,this.aspect=t,this.near=s,this.far=i}transform(t){return t.matrix().rotate(this.rotate.clone().invert()).translate(this.position.clone().invert())}perspective(){return(new s).perspective(this.fov,this.aspect,this.near,this.far)}};class o extends e{constructor(){super(...arguments),this.faces=[]}addFace(t){return this.faces.push(t),this}}class a{constructor(t,e,r){this.verts=[],this.normals=[],t.addFace(this),e.addFace(this),r.addFace(this),this.verts.push(t,e,r),this.normal=e.clone().sub(t).cross(r.clone().sub(t)).normalize()}calcNormals(t){return this.verts.forEach((e,r)=>{let s;e.faces.forEach(e=>{this.normal.dot(e.normal)>t&&(s=s?s.add(e.normal):e.normal.clone())}),this.normals.push(s?s.normalize():this.normal)}),this}pushVerts(t){return this.verts.forEach(e=>{t.push(...e.toArray())}),this}pushNormals(t){return this.normals.forEach(e=>{t.push(...e.toArray())}),this}}t.Mesh=class{constructor(e,r,s=[],i=0,o=360){if(r<2)return;s.length<2&&(s=this.sphere(s.length>0?s[0]+2:Math.ceil(r/2)+1));const a=this.createVerts(r,s,0,o),n=this.createFaces(a,r,s.length/2),h=Math.cos(i*t.RAD_SCALE),c=[],u=[];n.forEach(t=>{t.calcNormals(h).pushVerts(c).pushNormals(u)}),this.verts=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.verts),e.bufferData(e.ARRAY_BUFFER,new Float32Array(c),e.STATIC_DRAW),this.normals=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.normals),e.bufferData(e.ARRAY_BUFFER,new Float32Array(u),e.STATIC_DRAW),this.length=c.length/3}sphere(t){const e=[];if(t<3)return;let r=Math.PI/(t-1);for(let s=1;s<t-1;s++){let t=r*s;e.push(Math.sin(t)/2),e.push(Math.cos(t)/2)}return e}createVerts(e,r,s,i){s*=t.RAD_SCALE;let a=[],n=((i*=t.RAD_SCALE)-s)/e;a.push(new o(0,.5,0)),a.push(new o(0,-.5,0));for(let t=0;t<e;t++){let e=n*t+s,i=Math.cos(e),h=Math.sin(e);for(let t=0;t<r.length;t+=2){let e=new o(i,0,h);e.scale(r[t]).y=r[t+1],a.push(e)}}return a}createFaces(t,e,r){const s=[];let i;for(let o=1;o<e;++o){i=o*r+2,s.push(new a(t[0],t[i],t[i-r])),s.push(new a(t[1],t[i-1],t[i+r-1]));for(let e=0;e<r-1;e++){let o=i+e;s.push(new a(t[o+1],t[o-r],t[o])),s.push(new a(t[o-r+1],t[o-r],t[o+1]))}}s.push(new a(t[0],t[2],t[i])),s.push(new a(t[1],t[i+r-1],t[r+1]));for(let e=0;e<r-1;e++){let r=i+e;s.push(new a(t[e+3],t[r],t[e+2])),s.push(new a(t[r+1],t[r],t[e+3]))}return s}};t.Item=class{constructor(t,e,r){this.childs=[],this.active=!0,this.mesh=t,this.color=e,this.transform=new i(r)}add(t){return this.childs.push(t),t.transform.parent=this.transform,this}};t.Shader=class{constructor(t,e,r){this.attribs={},this.location={},this.gl=t,this.program=t.createProgram(),this.indices=t.createBuffer();const s=this.program;t.attachShader(s,this.create(t.VERTEX_SHADER,e)),t.attachShader(s,this.create(t.FRAGMENT_SHADER,r)),t.linkProgram(s),t.getProgramParameter(s,t.LINK_STATUS)||(console.log(t.getProgramInfoLog(s)),t.deleteProgram(s))}create(t,e){const r=this.gl,s=r.createShader(t);return r.shaderSource(s,e),r.compileShader(s),r.getShaderParameter(s,r.COMPILE_STATUS)||console.log(r.getShaderInfoLog(s)),s}attrib(t,e,r){const s=this.gl;this.location[t]||(this.location[t]=s.getAttribLocation(this.program,t));const i=this.location[t];return s.bindBuffer(s.ARRAY_BUFFER,e),s.enableVertexAttribArray(i),s.vertexAttribPointer(i,r,s.FLOAT,!1,0,0),this}uniform(t,e){const r=this.gl;this.location[t]||(this.location[t]=r.getUniformLocation(this.program,t));const s=this.location[t];if("number"==typeof e)return r.uniform1f(s,e),this;switch(e.length){case 2:r.uniform2fv(s,e);break;case 3:r.uniform3fv(s,e);break;case 4:r.uniform4fv(s,e);break;case 9:r.uniformMatrix3fv(s,!1,e);break;case 16:r.uniformMatrix4fv(s,!1,e)}return this}}}(T3D||(T3D={})),function(t){t.Hero=class extends T3D.Item{init(){this.active=!0,this.transform=new T3D.Transform,this.transform.scale.set(.8,.8,.8),this.x=0,this.rad=.4,this.acc=-.02,this.fall=!1,this.speed=new T3D.Vec3(0,0,.05),this.timer=0,this.tokens=0,this.distance=0}jump(){this.transform.translate.y||(this.acc=.07)}boost(){this.timer=60}speedZ(){return this.speed.z+(this.timer?.05:0)}update(){if(this.timer&&(this.timer-=this.timer>0?1:0),!this.active)return;this.acc-=this.acc>-.02?.01:0;let t=this.transform.translate,e=this.transform.rotate;t.x+=(this.x-t.x)/7,e.z=90+20*(t.x-this.x),e.y=(e.y+100*this.speedZ())%360,this.speed.y+=this.acc,t.y+=this.speed.y,t.y<0&&!this.fall&&(this.speed.y=0,t.y=0),this.active=t.y>-10}}}(Game||(Game={})),function(t){t.Map=class{constructor(){this.count=0,this.rand()}rand(e=!0){e?(this.platform=t.Rand.get(6,1),this.max=t.Rand.get(7,4),this.min=t.Rand.get(this.max-2,this.max-3)):this.platform=7,this.token=t.Rand.get(7,0)&this.platform}update(){switch(++this.count>=this.max&&(this.count=0),this.count){case 0:this.rand();break;case this.min:this.rand(!1)}}}}(Game||(Game={})),function(t){t.Platform=class extends T3D.Item{update(t){let e=this.transform.translate,r=this.token.transform.rotate;e.z+=t;let s=e.z>2;s&&(e.z-=11);let i=1;return e.z<-8?i=e.z+9:e.z>1&&(i=2-e.z),this.transform.scale.set(i,i,i),r.y=(r.y+1)%360,s}}}(Game||(Game={})),function(t){t.Scene=class extends T3D.Item{constructor(e){super(),this.map=new t.Map,this.hero=new t.Hero(new T3D.Mesh(e,10),[.1,1,.1,10]),this.add(this.hero),this.platforms=[];const r=new T3D.Mesh(e,4,[.65,.5,.2,-.5]),s=new T3D.Mesh(e,9,[.45,.3,.45,.5,.5,.5,.5,-.5,.45,-.5,.45,-.3],30),i=[.3,.3,1,30],o=[1,1,.3,30];for(let e=0;e<33;e++){let e=new t.Platform(r,i);e.token=new T3D.Item(s,o,[,1,,90,,,.5,.1,.5]),e.add(e.token),this.platforms.push(e),this.add(e)}this.init()}init(){this.row=9,this.distance=0,this.hero.init();let t=0;for(let e=-9;e<2;e++)for(let r=-1;r<=1;r++){let s=this.platforms[t++];s.transform.rotate.y=45,s.transform.translate.set(r,-1,e),s.token.active=!1,s.active=!0}}input(t,e){if(this.hero.fall)return void(t.Space&&this.init());const r=this.hero;(t.ArrowLeft||t.KeyA)&&e&&r.x>=0&&r.x--,(t.ArrowRight||t.KeyD)&&e&&r.x<=0&&r.x++,(t.ArrowUp||t.KeyW)&&e&&r.jump(),t.Space&&r.boost()}updateIndex(t){return this.row-=t,this.row<=-.5&&(this.row+=11),3*Math.round(this.row)+Math.round(this.hero.transform.translate.x)+1}update(){let t=!1,e=this.hero,r=e.speedZ();if(e.update(),this.platforms.forEach((e,s)=>{e.update(r)&&(e.active=(this.map.platform>>s%3&1)>0,e.token.active=(this.map.token>>s%3&1)>0,t=!0)}),t&&this.map.update(),this.distance+=r,e.fall)return;let s=e.transform.translate,i=this.updateIndex(r),o=this.platforms[i],a=o.token;a.active&&(a.active=!1,e.tokens++),e.fall=!s.y&&!o.active,e.distance=this.distance}}}(Game||(Game={})),function(t){function e(t,e){return(e||document).querySelector(t)}function r(t,e,r){t.addEventListener(e,r,!1)}t.fullscreen=function(){document.webkitFullscreenElement?document.webkitExitFullscreen&&(document.webkitExitFullscreen(),document.exitPointerLock()):(document.documentElement.webkitRequestFullscreen(),i.requestPointerLock())};class s{static get(t=1,e=0,r=!0){s.seed=(9301*s.seed+49297)%233280;let i=e+s.seed/233280*(t-e);return r?Math.round(i):i}}s.seed=Math.random(),t.Rand=s;let i=e("#game"),o=e("#hud"),a=i.getContext("experimental-webgl"),n=new t.Scene(a),h=new T3D.Camera(i.width/i.height),c={position:new T3D.Vec3(5,15,3),ambient:[.2,.2,.2],diffuse:[.8,.8,.8],specular:[.8,.8,.8]},u=new T3D.Shader(a,"precision mediump float;attribute vec3 aPos, aNorm;uniform mat4 uWorld, uProj;uniform mat3 uInverse;uniform float uStroke;varying vec4 vPos;varying vec3 vNorm;void main(void) {vec3 pos = aPos + (aNorm * uStroke);vPos = uWorld * vec4(pos, 1.0);vNorm = uInverse * aNorm;gl_Position = uProj * vPos;}","precision mediump float;uniform mat4 uWorld;uniform vec4 uColor;uniform vec3 uLight;uniform vec3 uAmbient;uniform vec3 uDiffuse;uniform vec3 uSpecular;uniform float uLevels;varying vec4 vPos;varying vec3 vNorm;void main(void) {vec3 lightDir = normalize(uLight - vPos.xyz);vec3 normal = normalize(vNorm);vec3 eyeDir = normalize(-vPos.xyz);vec3 reflectionDir = reflect(-lightDir, normal);float specularWeight = 0.0;if (uColor.w > 0.0) { specularWeight = pow(max(dot(reflectionDir, eyeDir), 0.0), uColor.w); }float diffuseWeight = max(dot(normal, lightDir), 0.0);vec3 weight = uAmbient + uSpecular * specularWeight  + uDiffuse * diffuseWeight;vec3 color = uColor.xyz * weight;if (uLevels > 1.0) { color = floor(color * uLevels) * (1.0 / uLevels); }gl_FragColor = vec4(color, 1);}");function l(){i.width=i.clientWidth,i.height=i.clientHeight,h.aspect=i.width/i.height,a.viewport(0,0,i.width,i.height)}function m(t,e=0){t.childs.forEach(t=>{m(t,e)});t.transform.scale;if(!t.active||!t.mesh)return;let r=t.transform.matrix().invert();r&&(a.cullFace(e>0?a.FRONT:a.BACK),a.useProgram(u.program),u.attrib("aPos",t.mesh.verts,3).attrib("aNorm",t.mesh.normals,3).uniform("uWorld",h.transform(t.transform).data).uniform("uProj",h.perspective().data).uniform("uInverse",r.transpose().data).uniform("uColor",e?[0,0,0,1]:t.color).uniform("uLight",c.position.clone().sub(h.position).toArray()).uniform("uAmbient",c.ambient).uniform("uDiffuse",c.diffuse).uniform("uSpecular",c.specular).uniform("uStroke",e||0).uniform("uLevels",e?0:5),a.drawArrays(a.TRIANGLES,0,t.mesh.length))}function f(){requestAnimationFrame(f),n.update(),h.position.x=n.hero.transform.translate.x,a.clear(a.COLOR_BUFFER_BIT),m(n),m(n,.02),o.textContent=`Distance: ${n.hero.distance.toFixed(2)}\nTokens: ${n.hero.tokens}`}r(window,"load",()=>{h.position.set(0,1,7),h.rotate.x=-1,a.clearColor(0,0,0,0),a.enable(a.CULL_FACE),a.enable(a.DEPTH_TEST),l(),function(){let t=0,e=0,s=!1,i={};r(document,"touchstart",r=>{let i=r.touches[0];t=i.clientX,e=i.clientY,s=!0}),r(document,"touchmove",r=>{if(!s)return;let o=r.touches[0];!i.ArrowRight&&o.clientX-t>20&&(i.ArrowRight=!0,n.input(i,!0),s=!1),!i.ArrowLeft&&o.clientX-t<-20&&(i.ArrowLeft=!0,n.input(i,!0),s=!1),!i.ArrowDown&&o.clientY-e>20&&(i.ArrowDown=!0,n.input(i,!0),s=!1),!i.ArrowUp&&o.clientY-e<-20&&(i.ArrowUp=!0,n.input(i,!0),s=!1)}),r(document,"touchend",t=>{s&&(i.Space=!0,n.input(i,!0)),i.Space=i.ArrowRight=i.ArrowLeft=i.ArrowUp=i.ArrowDown=s=!1,n.input(i,!1)}),r(document,"keydown",t=>{i[t.code]||(i[t.code]=!0,i[0]=i.Enter||i.Space||t.shiftKey||t.ctrlKey,n.input(i,!0))}),r(document,"keyup",t=>{i[t.code]&&(i[t.code]=!1,i[0]=i[13]||i[32]||t.shiftKey||t.ctrlKey,n.input(i,!1))}),r(window,"resize",l)}(),f()})}(Game||(Game={}));